<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/src/main/java/repository/TransaksiRepository.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/src/main/java/repository/TransaksiRepository.java" />
              <option name="originalContent" value="package repository;&#10;&#10;import dto.request.TransaksiRequestDTO;&#10;import dto.request.TransaksiDetailRequestDTO;&#10;import dto.response.TransaksiResponseDTO;&#10;import util.DBConnection;&#10;&#10;import java.util.ArrayList;&#10;import java.sql.*;&#10;import java.util.List;&#10;&#10;public class TransaksiRepository {&#10;&#10;    public String createTransaksi(TransaksiRequestDTO request) {&#10;        String noFaktur = generateNoFaktur();&#10;        Connection conn = null;&#10;        PreparedStatement stmtTransaksi = null;&#10;        PreparedStatement stmtDetail = null;&#10;&#10;        try {&#10;            conn = DBConnection.get();&#10;            conn.setAutoCommit(false); // Start transaction&#10;&#10;            // Insert into transaksi&#10;            String sqlTransaksi = &quot;INSERT INTO transaksi (no_faktur, nopol, nama_mekanik, keluhan, total_belanja) VALUES (?, ?, ?, ?, ?)&quot;;&#10;            stmtTransaksi = conn.prepareStatement(sqlTransaksi);&#10;            stmtTransaksi.setString(1, noFaktur);&#10;            stmtTransaksi.setString(2, request.getNopol());&#10;            stmtTransaksi.setString(3, request.getNamaMekanik());&#10;            stmtTransaksi.setString(4, request.getKeluhan());&#10;            stmtTransaksi.setDouble(5, request.getTotalBelanja());&#10;            stmtTransaksi.executeUpdate();&#10;&#10;            // Insert into transaksi_detail&#10;            String sqlDetail = &quot;INSERT INTO transaksi_detail (no_faktur, nama_item, jenis, qty, harga_modal, harga_deal, catatan) VALUES (?, ?, ?, ?, &quot; +&#10;                &quot;CASE WHEN ? = 'BARANG' THEN (SELECT harga_beli FROM barang WHERE nama_barang = ?) ELSE 0 END, ?, ?)&quot;;&#10;            stmtDetail = conn.prepareStatement(sqlDetail);&#10;&#10;            List&lt;TransaksiDetailRequestDTO&gt; details = request.getDetailRequestDTOList();&#10;            for (TransaksiDetailRequestDTO detail : details) {&#10;                stmtDetail.setString(1, noFaktur);&#10;                stmtDetail.setString(2, detail.getJenis().equals(&quot;BARANG&quot;) ? detail.getNamaBarang() : detail.getNamaBarang()); // Assuming namaBarang is namaItem&#10;                stmtDetail.setString(3, detail.getJenis());&#10;                stmtDetail.setInt(4, detail.getJumlah());&#10;                stmtDetail.setString(5, detail.getJenis());&#10;                stmtDetail.setString(6, detail.getNamaBarang());&#10;                stmtDetail.setDouble(7, detail.getHargaDibayar());&#10;                stmtDetail.setString(8, detail.getCatatan());&#10;                stmtDetail.executeUpdate();&#10;            }&#10;&#10;            conn.commit();&#10;            return noFaktur;&#10;        } catch (SQLException e) {&#10;            try {&#10;                if (conn != null) conn.rollback();&#10;            } catch (SQLException ex) {&#10;                ex.printStackTrace();&#10;            }&#10;            e.printStackTrace();&#10;        } finally {&#10;            try {&#10;                if (stmtTransaksi != null) stmtTransaksi.close();&#10;                if (stmtDetail != null) stmtDetail.close();&#10;                DBConnection.close(conn);&#10;            } catch (SQLException e) {&#10;                e.printStackTrace();&#10;            }&#10;        }&#10;        return null;&#10;    }&#10;&#10;    private String generateNoFaktur() {&#10;        String prefix = &quot;TRX-&quot;;&#10;        String sql = &quot;SELECT MAX(no_faktur) FROM transaksi WHERE no_faktur LIKE ?&quot;;&#10;        Connection conn = null;&#10;        PreparedStatement stmt = null;&#10;        ResultSet rs = null;&#10;&#10;        try {&#10;            conn = DBConnection.get();&#10;            stmt = conn.prepareStatement(sql);&#10;            stmt.setString(1, prefix + &quot;%&quot;);&#10;            rs = stmt.executeQuery();&#10;&#10;            if (rs.next()) {&#10;                String maxNo = rs.getString(1);&#10;                if (maxNo != null &amp;&amp; maxNo.startsWith(prefix)) {&#10;                    String numStr = maxNo.substring(prefix.length());&#10;                    try {&#10;                        long num = Long.parseLong(numStr);&#10;                        num++;&#10;                        return prefix + String.format(&quot;%012d&quot;, num);&#10;                    } catch (NumberFormatException e) {&#10;                        // Jika gagal parse, mulai dari 1&#10;                    }&#10;                }&#10;            }&#10;            // Jika tidak ada atau gagal, mulai dari 1&#10;            return prefix + String.format(&quot;%012d&quot;, 1L);&#10;        } catch (SQLException e) {&#10;            e.printStackTrace();&#10;            // Fallback ke timestamp jika error&#10;            return prefix + System.currentTimeMillis();&#10;        } finally {&#10;            try {&#10;                if (rs != null) rs.close();&#10;                if (stmt != null) stmt.close();&#10;                DBConnection.close(conn);&#10;            } catch (SQLException e) {&#10;                e.printStackTrace();&#10;            }&#10;&#10;    public List&lt;TransaksiResponseDTO&gt; getAllTransaksi() {&#10;        String sql = &quot;SELECT t.no_faktur, t.tanggal, p.nama_pemilik, t.nama_mekanik, t.total_belanja FROM transaksi t JOIN pelanggan p ON t.nopol = p.nopol ORDER BY t.tanggal DESC&quot;;&#10;        List&lt;TransaksiResponseDTO&gt; list = new ArrayList&lt;&gt;();&#10;        Connection conn = null;&#10;        Statement stmt = null;&#10;        ResultSet rs = null;&#10;&#10;        try {&#10;            conn = DBConnection.get();&#10;            stmt = conn.createStatement();&#10;            rs = stmt.executeQuery(sql);&#10;    }&#10;            while (rs.next()) {&#10;                String noFaktur = rs.getString(&quot;no_faktur&quot;);&#10;                Date tanggal = rs.getTimestamp(&quot;tanggal&quot;);&#10;                String namaPelanggan = rs.getString(&quot;nama_pemilik&quot;);&#10;                String namaMekanik = rs.getString(&quot;nama_mekanik&quot;);&#10;                double totalBelanja = rs.getDouble(&quot;total_belanja&quot;);&#10;                list.add(new TransaksiResponseDTO(noFaktur, tanggal, namaPelanggan, namaMekanik, totalBelanja));&#10;            }&#10;        } catch (SQLException e) {&#10;            e.printStackTrace();&#10;        } finally {&#10;            try {&#10;                if (rs != null) rs.close();&#10;                if (stmt != null) stmt.close();&#10;                DBConnection.close(conn);&#10;            } catch (SQLException e) {&#10;                e.printStackTrace();&#10;            }&#10;        }&#10;        return list;&#10;    }&#10;}&#10;}&#10;" />
              <option name="updatedContent" value="package repository;&#10;&#10;import dto.request.TransaksiRequestDTO;&#10;import dto.request.TransaksiDetailRequestDTO;&#10;import dto.response.TransaksiResponseDTO;&#10;import util.DBConnection;&#10;&#10;import java.util.ArrayList;&#10;import java.sql.*;&#10;import java.util.Date;&#10;import java.util.List;&#10;&#10;public class TransaksiRepository {&#10;&#10;    public String createTransaksi(TransaksiRequestDTO request) {&#10;        String noFaktur = generateNoFaktur();&#10;        Connection conn = null;&#10;        PreparedStatement stmtTransaksi = null;&#10;        PreparedStatement stmtDetail = null;&#10;&#10;        try {&#10;            conn = DBConnection.get();&#10;            conn.setAutoCommit(false); // Start transaction&#10;&#10;            // Insert into transaksi&#10;            String sqlTransaksi = &quot;INSERT INTO transaksi (no_faktur, nopol, nama_mekanik, keluhan, total_belanja) VALUES (?, ?, ?, ?, ?)&quot;;&#10;            stmtTransaksi = conn.prepareStatement(sqlTransaksi);&#10;            stmtTransaksi.setString(1, noFaktur);&#10;            stmtTransaksi.setString(2, request.getNopol());&#10;            stmtTransaksi.setString(3, request.getNamaMekanik());&#10;            stmtTransaksi.setString(4, request.getKeluhan());&#10;            stmtTransaksi.setDouble(5, request.getTotalBelanja());&#10;            stmtTransaksi.executeUpdate();&#10;&#10;            // Insert into transaksi_detail&#10;            String sqlDetail = &quot;INSERT INTO transaksi_detail (no_faktur, nama_item, jenis, qty, harga_modal, harga_deal, catatan) VALUES (?, ?, ?, ?, &quot; +&#10;                &quot;CASE WHEN ? = 'BARANG' THEN (SELECT harga_beli FROM barang WHERE nama_barang = ?) ELSE 0 END, ?, ?)&quot;;&#10;            stmtDetail = conn.prepareStatement(sqlDetail);&#10;&#10;            List&lt;TransaksiDetailRequestDTO&gt; details = request.getDetailRequestDTOList();&#10;            for (TransaksiDetailRequestDTO detail : details) {&#10;                stmtDetail.setString(1, noFaktur);&#10;                stmtDetail.setString(2, detail.getJenis().equals(&quot;BARANG&quot;) ? detail.getNamaBarang() : detail.getNamaBarang()); // Assuming namaBarang is namaItem&#10;                stmtDetail.setString(3, detail.getJenis());&#10;                stmtDetail.setInt(4, detail.getJumlah());&#10;                stmtDetail.setString(5, detail.getJenis());&#10;                stmtDetail.setString(6, detail.getNamaBarang());&#10;                stmtDetail.setDouble(7, detail.getHargaDibayar());&#10;                stmtDetail.setString(8, detail.getCatatan());&#10;                stmtDetail.executeUpdate();&#10;            }&#10;&#10;            conn.commit();&#10;            return noFaktur;&#10;        } catch (SQLException e) {&#10;            try {&#10;                if (conn != null) conn.rollback();&#10;            } catch (SQLException ex) {&#10;                ex.printStackTrace();&#10;            }&#10;            e.printStackTrace();&#10;        } finally {&#10;            try {&#10;                if (stmtTransaksi != null) stmtTransaksi.close();&#10;                if (stmtDetail != null) stmtDetail.close();&#10;                DBConnection.close(conn);&#10;            } catch (SQLException e) {&#10;                e.printStackTrace();&#10;            }&#10;        }&#10;        return null;&#10;    }&#10;&#10;    private String generateNoFaktur() {&#10;        String prefix = &quot;TRX-&quot;;&#10;        String sql = &quot;SELECT MAX(no_faktur) FROM transaksi WHERE no_faktur LIKE ?&quot;;&#10;        Connection conn = null;&#10;        PreparedStatement stmt = null;&#10;        ResultSet rs = null;&#10;&#10;        try {&#10;            conn = DBConnection.get();&#10;            stmt = conn.prepareStatement(sql);&#10;            stmt.setString(1, prefix + &quot;%&quot;);&#10;            rs = stmt.executeQuery();&#10;&#10;            if (rs.next()) {&#10;                String maxNo = rs.getString(1);&#10;                if (maxNo != null &amp;&amp; maxNo.startsWith(prefix)) {&#10;                    String numStr = maxNo.substring(prefix.length());&#10;                    try {&#10;                        long num = Long.parseLong(numStr);&#10;                        num++;&#10;                        return prefix + String.format(&quot;%012d&quot;, num);&#10;                    } catch (NumberFormatException e) {&#10;                        // Jika gagal parse, mulai dari 1&#10;                    }&#10;                }&#10;            }&#10;            // Jika tidak ada atau gagal, mulai dari 1&#10;            return prefix + String.format(&quot;%012d&quot;, 1L);&#10;        } catch (SQLException e) {&#10;            e.printStackTrace();&#10;            // Fallback ke timestamp jika error&#10;            return prefix + System.currentTimeMillis();&#10;        } finally {&#10;            try {&#10;                if (rs != null) rs.close();&#10;                if (stmt != null) stmt.close();&#10;                DBConnection.close(conn);&#10;            } catch (SQLException e) {&#10;                e.printStackTrace();&#10;            }&#10;        }&#10;    }&#10;&#10;    public List&lt;TransaksiResponseDTO&gt; getAllTransaksi() {&#10;        String sql = &quot;SELECT t.no_faktur, t.tanggal, p.nama_pemilik, t.nama_mekanik, t.total_belanja FROM transaksi t JOIN pelanggan p ON t.nopol = p.nopol ORDER BY t.tanggal DESC&quot;;&#10;        List&lt;TransaksiResponseDTO&gt; list = new ArrayList&lt;&gt;();&#10;        Connection conn = null;&#10;        Statement stmt = null;&#10;        ResultSet rs = null;&#10;&#10;        try {&#10;            conn = DBConnection.get();&#10;            stmt = conn.createStatement();&#10;            rs = stmt.executeQuery(sql);&#10;&#10;            while (rs.next()) {&#10;                String noFaktur = rs.getString(&quot;no_faktur&quot;);&#10;                Date tanggal = rs.getTimestamp(&quot;tanggal&quot;);&#10;                String namaPelanggan = rs.getString(&quot;nama_pemilik&quot;);&#10;                String namaMekanik = rs.getString(&quot;nama_mekanik&quot;);&#10;                double totalBelanja = rs.getDouble(&quot;total_belanja&quot;);&#10;                list.add(new TransaksiResponseDTO(noFaktur, tanggal, namaPelanggan, namaMekanik, totalBelanja));&#10;            }&#10;        } catch (SQLException e) {&#10;            e.printStackTrace();&#10;        } finally {&#10;            try {&#10;                if (rs != null) rs.close();&#10;                if (stmt != null) stmt.close();&#10;                DBConnection.close(conn);&#10;            } catch (SQLException e) {&#10;                e.printStackTrace();&#10;            }&#10;        }&#10;        return list;&#10;    }&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>